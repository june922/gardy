const ServiceEntry = require("../service-entries/serviceEntry.model");
const UserWorkspaceHospital = require("../user-workspace-hospitals/userWorkspaceHospital.model");
const Pateint = require("../patients/patient.model");
const Procedure = require("../procedures/procedures.model");
const PersonalProcedure = require("../personal-procedures/personalProcedure.model");
const PatientController = require("../patients/patientController");
const { fetchPatientById } = PatientController;
const WorkSpaceHospitalController = require("../user-workspace-hospitals/userWorkspaceHospitalController");
const { fetchUserWorkspaceHospitalById } = WorkSpaceHospitalController;
const User = require("../users/users.model");
const jwt = require("jsonwebtoken");
const config = require("../../config/auth.config");
const ProcedureLevel = require("../procedure-levels/procedureLevel.model");
const servicePaymentStatus = require("../service-payment-status/servicePaymenyStatus.model");

exports.createServiceEntry = async (req, res) => {
    const authHeader = req.headers["authorization"];
    const accessToken = authHeader.split(" ")[1];
    const decodedToken = jwt.verify(accessToken, config.secret);
    const userId = decodedToken.id;

    if (!req.body.patient_id) {
        return res.status(400).send({
            message: "Patient is required!",
        });
    }

    if (!req.body.user_id) {
        return res.status(400).send({
            message: "User is required!",
        });
    }

    // if (!("is_house_visit" in req.body)) {
    //     return res.status(400).send({
    //         message: "is_house_visit value is required!",
    //     });
    // }

    // const { is_house_visit } = req.body;

    // if (is_house_visit !== true && is_house_visit !== false) {
    //     return res.status(400).send({
    //         message: "is_house_visit value is invalid!",
    //     });
    // }

    if (isNaN(req.body.workspace_hospital_id)) {
        return res.status(400).send({
            message: "Valid workspace hospital is required!",
        });
    }

    if (!req.body.procedure_id) {
        return res.status(400).send({
            message: "Procedure is required!",
        });
    }

    if (!("is_personal_procedure" in req.body)) {
        return res.status(400).send({
            message: "is_personal_procedure value is required!",
        });
    }

    const { is_personal_procedure } = req.body;

    if (is_personal_procedure !== true && is_personal_procedure !== false) {
        return res.status(400).send({
            message: "is_personal_procedure value is invalid!",
        });
    }

    if (isNaN(req.body.service_cost)) {
        return res.status(400).send({
            message: "Valid Service Cost value is required!",
        });
    }

    if (!req.body.service_date) {
        return res.status(400).send({
            message: "Valid Service Date is required!",
        });
    }

    const serviceDate = new Date(req.body.service_date);

    // Check if the dates are valid
    if (isNaN(serviceDate.getFullYear())) {
    return res.status(400).json({
        error: 'Invalid service date format!'
    });
    }

    try {
        if (req.body.user_id != userId) {
            return res.status(403).send({
                message: "Unauthorized!",
            });
        }

        // Check if user exists
        const userExists = await User.query()
            .where({
                id: req.body.user_id,
            })
            .first();

        if (!userExists) {
            return res.status(400).send({
                message: "Failed! Provided user does not exist!",
            });
        }

        // Check if patient exists
        const patientExists = await Pateint.query()
            .where({
                id: req.body.patient_id,
                user_id: req.body.user_id,
            })
            .first();

        if (!patientExists) {
            return res.status(400).send({
                message: "Failed! Provided patient does not exist!",
            });
        }
        // Check if hospital exists
        const hospitalExists = await UserWorkspaceHospital.query()
            .where({
                id: req.body.workspace_hospital_id,
                user_id: req.body.user_id,
            })
            .first();

        if (!hospitalExists) {
            return res.status(400).send({
                message: "Failed! Provided hospital does not exist!",
            });
        }


        // check if procedure exists
        if (req.body.is_personal_procedure == true) {
            const procedureExists = await PersonalProcedure.query()
                .where({
                    id: req.body.procedure_id,
                    user_id: req.body.user_id,
                })
                .first();

            if (!procedureExists) {
                return res.status(400).send({
                    message: "Failed! Provided procedure does not exist!",
                });
            }
        } else {
            const procedureExists = await Procedure.query()
                .where({
                    id: req.body.procedure_id,
                })
                .first();

            if (!procedureExists) {
                return res.status(400).send({
                    message: "Failed! Provided procedure does not exist!",
                });
            }
        }

        // get pending payment status
        const pendingPaymentStatus = await servicePaymentStatus.query().where({
            name: 'Pending'
        }).first();

        if (!pendingPaymentStatus) {
            return res.status(400).send({message: 'Could not get payment status',});
        }

        const payload = {
            patient_id: parseInt(req.body.patient_id),
            workspace_hospital_id: parseInt(req.body.workspace_hospital_id),
            service_cost: parseFloat(req.body.service_cost),
            procedure_id: parseInt(req.body.procedure_id),
            is_personal_procedure: req.body.is_personal_procedure,
            user_id: parseInt(userId),
            created_by: parseInt(userId),
            payment_status_id: pendingPaymentStatus.id,
            pending_amount: parseFloat(req.body.service_cost),
            service_date: serviceDate
            };


        const serviceEntry = await ServiceEntry.query().insert(payload);

        return res.status(201).send({
            message: "Service entry was created successfully!",
            data: serviceEntry
        });
    } catch (error) {
        console.log(error);
        return res.status(500).send({
            message: "Internal server error",
        });
    }
};

exports.getServiceEntryById = async (req, res) => {
    const authHeader = req.headers["authorization"];
    const accessToken = authHeader.split(" ")[1];
    const decodedToken = jwt.verify(accessToken, config.secret);
    const userId = decodedToken.id;

    const { id } = req.params;

    try {
        const serviceEntryData = await fetchServiceEntryById(id, userId);
        if (!serviceEntryData) {
            return res.status(404).json({ error: "Service entry not found" });
        }

        if (serviceEntryData.deleted === true) {
            return res.status(404).json({ error: "Service entry not found" });
        }

        res.status(200).json(serviceEntryData);
    } catch (error) {
        console.log(error);
        return res.status(500).send({
            message: "Internal server error",
        });
    }
};

exports.getAllUserServiceEntries = async (req, res) => {
    const authHeader = req.headers["authorization"];
    const accessToken = authHeader.split(" ")[1];
    const decodedToken = jwt.verify(accessToken, config.secret);
    const userId = decodedToken.id;

    const { userid } = req.params;

    try {
        const userServiceEntries = await ServiceEntry.query().where({
            user_id: userid,
        });
        const formatedUserServiceEntries = await Promise.all(
          userServiceEntries
              .filter(serviceentry => serviceentry.deleted !== true) // filter out deleted entries
              .map(serviceentry => fetchServiceEntryById(serviceentry.id, userId))
      );

      res.status(200).json(formatedUserServiceEntries);

  } catch (error) {
      return res.status(500).send({
          message: "Internal server error",
      });
  }
};

// TODO : Get by hospital

exports.getHospitalServiceEntries = async (req, res) => {
  const authHeader = req.headers["authorization"];
  const accessToken = authHeader.split(" ")[1];
  const decodedToken = jwt.verify(accessToken, config.secret);
  const userId = decodedToken.id;

  const { userid } = req.params;
  const { hospitalid } = req.params;

  try {
      const userServiceEntries = await ServiceEntry.query().where({
          user_id: userid,
          workspace_hospital_id: hospitalid
      });

      const formatedUserServiceEntries = await Promise.all(
          userServiceEntries
              .filter(serviceentry => serviceentry.deleted !== true) // filter out deleted entries
              .map(serviceentry => fetchServiceEntryById(serviceentry.id, userId))
      );

      res.status(200).json(formatedUserServiceEntries);

  } catch (error) {
      return res.status(500).send({
          message: "Internal server error",
      });
  }
};
// TODO : Get for a specific date

exports.getDateServiceEntries = async (req, res) => {
  const authHeader = req.headers["authorization"];
  const accessToken = authHeader.split(" ")[1];
  const decodedToken = jwt.verify(accessToken, config.secret);
  const userId = decodedToken.id;

  const { userid } = req.params;
  const { date } = req.params;

  // Function to check if the date is valid (in YYYY-MM-DD format)
  const isValidDate = (dateString) => {
      // Check if date matches the YYYY-MM-DD format and if it is a real date
      const date = new Date(dateString);
      return date instanceof Date && !isNaN(date) && dateString.match(/^\d{4}-\d{2}-\d{2}$/);
  };

  if (!isValidDate(date)) {
      return res.status(400).json({ error: 'Invalid date format. Please provide a valid date in YYYY-MM-DD format.' });
  }

  const parsedDate = new Date(date);
  const startOfDay = new Date(parsedDate.setHours(0, 0, 0, 0)).toISOString();
  const endOfDay = new Date(parsedDate.setHours(23, 59, 59, 999)).toISOString();

  try {
      const userServiceEntries = await ServiceEntry.query()
      .where('user_id', userid)
      .whereBetween('service_date', [startOfDay, endOfDay]);

      const formatedUserServiceEntries = await Promise.all(
          userServiceEntries
              .filter(serviceentry => serviceentry.deleted !== true) // filter out deleted entries
              .map(serviceentry => fetchServiceEntryById(serviceentry.id, userId))
      );

      res.status(200).json(formatedUserServiceEntries);

  } catch (error) {
      return res.status(500).send({
          message: "Internal server error",
      });
  }
};

// TODO : Update
// TODO : Delete
// TODO : Get Deleted
// TODO : Search

const fetchServiceEntryById = async (id, userId) => {
  const serviceEntry = await ServiceEntry.query().findById(id);

  if (!serviceEntry) {
      return null;
  }

  // get payment status
  const paymentStatus = await servicePaymentStatus.query().findById(serviceEntry.payment_status_id);
  if (paymentStatus) {
      serviceEntry.payment_status = paymentStatus.name;
  }

  // get patient details
  const patientData = await fetchPatientById(serviceEntry.patient_id, userId);
  if (patientData) {
      serviceEntry.patient = patientData;
  }
  // get procedure details
  if (serviceEntry.is_personal_procedure === true) {
    const procedureData = await PersonalProcedure.query().findById(
        serviceEntry.procedure_id
    );
    if (procedureData) {
        procedureData.is_personal = true;
        serviceEntry.procedure = procedureData;
        const procedureLevel = await ProcedureLevel.query().findById(
            procedureData.level_id
        );
        if (procedureLevel) {
            serviceEntry.procedure.level_name = procedureLevel.name;
            serviceEntry.procedure.is_personal = true;
        }
    } else {
        serviceEntry.procedure = {};
    }
} else {
    const procedureData = await Procedure.query().findById(
        serviceEntry.procedure_id
    );
    if (procedureData) {
        procedureData.is_personal = false;
        serviceEntry.procedure = procedureData;
        const procedureLevel = await ProcedureLevel.query().findById(
            procedureData.level_id
        );
        if (procedureLevel) {
            serviceEntry.procedure.level_name = procedureLevel.name;
            serviceEntry.procedure.is_personal = false;
        }
    } else {
        serviceEntry.procedure = {};
    }
}

// get workspace hospital
const hospitalData = await fetchUserWorkspaceHospitalById(serviceEntry.workspace_hospital_id);
if (hospitalData) {
    serviceEntry.workspace_hospital = hospitalData;
} else {
    serviceEntry.workspace_hospital = {};
}

return serviceEntry;
};